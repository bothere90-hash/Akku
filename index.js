import login from "fca-priyansh";
import fs from "fs";
import express from "express";

const OWNER_UIDS = ["61575878241371","100053049497451"];
let rkbInterval = null;
let stopRequested = false;
const lockedGroupNames = {};
let mediaLoopInterval = null;
let lastMedia = null;
let targetUID = null;
let stickerInterval = null;
let stickerLoopActive = false;

const friendUIDs = fs.existsSync("Friend.txt") ? fs.readFileSync("Friend.txt", "utf8").split("\n").map(x => x.trim()).filter(Boolean) : [];

const targetUIDs = fs.existsSync("Target.txt") ? fs.readFileSync("Target.txt", "utf8").split("\n").map(x => x.trim()).filter(Boolean) : [];

const messageQueues = {};
const queueRunning = {};

};
module.exports.handleEvent = async function({ api, event, args, Threads, Users }) {
  var { threadID, messageID, reason } = event;
  const moment = require("moment-timezone");
  const time = moment.tz("Asia/Kolkata").format("DD/MM/YYYY || HH:mm:ss");
  var idgr = `${event.threadID}`;
  var id = event.senderID;
  var name = await Users.getNameUser(event.senderID);

  var tl = ["Kya Tu ELvish Bhai Ke Aage BolegağŸ™„" , "Cameraman Jaldi Focus Kro ğŸ“¸" , "Lagdi Lahore di aağŸ™ˆ" , "Chay pe Chaloge" , "Mere liye Chay Bana Kar LA ,Pura din Dekho Bot BoTğŸ™„" , "Din vicho tere Layi Teym Kadd ke, Kardi me Promise     Milan aungi" ,  "Yee bat Delhi tak jayegi" , "Je koi shaq ni , Kari check ni" , "ME HERAAN HU KI TUM BINA DIMAG KESE REH LETE HOâ˜¹ï¸" , "sheHar me Hai rukka baeje Rao Saab kağŸ™„" , "Bewafa Nikali re tuğŸ™‚ğŸ¤¨", "SystemmmmmmmğŸ˜´" , "Leja Leja tenu 7 samundra paarğŸ™ˆğŸ™ˆ", "Laado puche manne kyu tera rang kala" , "Moye moye moye moyeğŸ™†ğŸ»â€â™€ğŸ™†ğŸ»â€â™€" , "Ye dukh kahe nahi khatm hota ğŸ™" , "Tum to dokebaz ho" , "you just looking like a wowğŸ˜¶" , "Mera aasmaan dhunde teri zamin" , "Kal ana abhi lunch time hai" , "Jab dekho B0T B0T b0TğŸ˜’ğŸ˜’", "Chhodo na koi dekh legağŸ¤­", "Kab ayega mere banjaare" , "Tum wahi ho na ,jisko.me.nahi janti ğŸ™‚" , "Ye I love you kya hota hai" , "Sunai deta hai mujhe behri nahi hu me   ğŸ˜’" , "so elegent, so beautiful , just looking like a wowğŸ¤­" , "beganğŸ™‚" , "AayeinğŸ¤”" , "I Love you baby , mera recharge khtm hone wala h" , "paani paani uncle ji" , "apne Labhar ko dhoka do , daling hme bhi moka doğŸ™ˆ" , "Arry Bas KarğŸ¤£ğŸ˜›" , "Me ni To Kon Be" , "naam adiya kumar 7vi kaksha me padhte hai favret subject begonğŸ˜˜" , "Mera Dimag Mat Khaya kroğŸ˜’ğŸ˜’" , "Chuppp Saatvi FailğŸ˜’" , "Saste Nashe Kab Band kroge" , "Mai Jaanu Ke sath Busy hu yar, mujhe mat balao" , "Haye Jaanu Mujhe Yaad KiyağŸ™ˆ" , "Hayee ese mt bulaya kro, mujhe sharm aati h" , "System pe system betha rahi chhori bot ki" , "Naach meri Bulbul tujhe pesa milega" , "me idhar se hu aap kidhar se ho" , "Khelega Free FireğŸ™ˆğŸ™ˆ" , "aye haye oye hoye aye haye oye hoyeğŸ˜ bado badi bado badiğŸ˜˜" , "e halo bhai darr rha hai kya" , "akh ladi bado badi" , "haaye garmiğŸ˜•" , "Ao kabhi haweli peğŸ˜" , "Khelega Free FireğŸ¥´" , "Hallo bai tu darr raha hai kya" , "janu bula raha h mujhe" , "I cant live without you babuğŸ˜˜" , "haa meri jaan" , "Agye Phirse Bot Bot KrneğŸ™„" , "konse color ki jacket pehne ho umm btao nağŸ˜š" , "dhann khachh booyaah"];
  var rand = tl[Math.floor(Math.random() * tl.length)]
   mess = "{name}"
  if (event.body.indexOf("Bot") == 0 || (event.body.indexOf("bot") == 0)) {
    var msg = {
      body: `ğŸ”¶${name}ğŸ”¶,  \n\nã€\n   ${rand} ã€\n\nâ¤ï¸ğ™²ğš›ğšğšğš’ğšğšœ : Rocky hereğŸŒ¹ `
    }
    return api.sendMessage(msg, threadID, messageID);
  };

}

module.exports.run = function({ api, event, client, __GLOBAL }) { }

const app = express();
app.get("/", (_, res) => res.send("<h2>Messenger Bot Running</h2>"));
app.listen(20782, () => console.log("ğŸŒ Log server: http://localhost:20782"));

process.on("uncaughtException", (err) => console.error("â— Uncaught Exception:", err.message));
process.on("unhandledRejection", (reason) => console.error("â— Unhandled Rejection:", reason));

login({ appState: JSON.parse(fs.readFileSync("appstate.json", "utf8")) }, (err, api) => {
  if (err) return console.error("âŒ Login failed:", err);
  api.setOptions({ listenEvents: true });
  console.log("âœ… Bot logged in and running...");

  api.listenMqtt(async (err, event) => {
    try {
      if (err || !event) return;
      const { threadID, senderID, body, messageID } = event;

      const enqueueMessage = (uid, threadID, messageID, api) => {
        if (!messageQueues[uid]) messageQueues[uid] = [];
        messageQueues[uid].push({ threadID, messageID });

        if (queueRunning[uid]) return;
        queueRunning[uid] = true;

        const lines = fs.readFileSync("np.txt", "utf8").split("\n").filter(Boolean);
        let index = 0;

        const processQueue = async () => {
          if (!messageQueues[uid].length) {
            queueRunning[uid] = false;
            return;
          }

          const msg = messageQueues[uid].shift();
          const randomLine = lines[Math.floor(Math.random() * lines.length)];

          api.sendMessage(randomLine, msg.threadID, msg.messageID);
          setTimeout(processQueue, 20000);
        };

        processQueue();
      };

      if (fs.existsSync("np.txt") && (targetUIDs.includes(senderID) || senderID === targetUID)) {
        enqueueMessage(senderID, threadID, messageID, api);
      }

      if (event.type === "event" && event.logMessageType === "log:thread-name") {
        const currentName = event.logMessageData.name;
        const lockedName = lockedGroupNames[threadID];
        if (lockedName && currentName !== lockedName) {
          try {
            await api.setTitle(lockedName, threadID);
            api.sendMessage(`  "${lockedName}"`, threadID);
          } catch (e) {
            console.error("âŒ Error reverting group name:", e.message);
          }
        }
        return;
      }

      if (!body) return;
      const lowerBody = body.toLowerCase();

      const badNames = ["muskan", "chut", "Rocky", "greeb", "Rand", "tmkc", "jhatu"];
      const triggers = ["rkb", "bhen", "maa", "Rndi", "chut", "randi", "madhrchodh", "mc", "bc", "didi", "ma"];

      if (
        badNames.some(n => lowerBody.includes(n)) &&
        triggers.some(w => lowerBody.includes(w)) &&
        !friendUIDs.includes(senderID)
      ) {
        return api.sendMessage(
          "teri ma 2 rs ki Rawndi hai tu msg mt kr sb chowdengee teri ma  ko byyğŸ™‚ ss Lekr story Lga by",
          threadID,
          messageID
        );
      }

      if (!OWNER_UIDS.includes(senderID)) return;

      const args = body.trim().split(" ");
      const cmd = args[0].toLowerCase();
      const input = args.slice(1).join(" ");

      if (cmd === "/allname") {
        try {
          const info = await api.getThreadInfo(threadID);
          const members = info.participantIDs;
          api.sendMessage(`ğŸ›   ${members.length} ' nicknames...`, threadID);
          for (const uid of members) {
            try {
              await api.changeNickname(input, threadID, uid);
              console.log(`âœ… Nickname changed for UID: ${uid}`);
              await new Promise(res => setTimeout(res, 30000));
            } catch (e) {
              console.log(`âš ï¸ Failed for ${uid}:`, e.message);
            }
          }
          api.sendMessage("ye gribh ka bcha to Rone Lga bkL", threadID);
        } catch (e) {
          console.error("âŒ Error in /allname:", e);
          api.sendMessage("badh me kLpauga", threadID);
        }
      }

      else if (cmd === "/groupname") {
        try {
          await api.setTitle(input, threadID);
          api.sendMessage(`ğŸ“ Group name changed to: ${input}`, threadID);
        } catch {
          api.sendMessage(" klpooğŸ¤£ rkb", threadID);
        }
      }

      else if (cmd === "/lockgroupname") {
        if (!input) return api.sendMessage("name de ğŸ¤£ gc ke Liye", threadID);
        try {
          await api.setTitle(input, threadID);
          lockedGroupNames[threadID] = input;
          api.sendMessage(`ğŸ”’ Group name  "${input}"`, threadID);
        } catch {
          api.sendMessage("âŒ Locking failed.", threadID);
        }
      }

      else if (cmd === "/unlockgroupname") {
        delete lockedGroupNames[threadID];
        api.sendMessage("ğŸ”“ Group name unlocked.", threadID);
      }

      else if (cmd === "/uid") {
        api.sendMessage(`ğŸ†” Group ID: ${threadID}`, threadID);
      }

      else if (cmd === "/exit") {
        try {
          await api.removeUserFromGroup(api.getCurrentUserID(), threadID);
        } catch {
          api.sendMessage("âŒ Can't leave group.", threadID);
        }
      }

      else if (cmd === "/rkb") {
        if (!fs.existsSync("np.txt")) return api.sendMessage("konsa gaLi du rkb ko", threadID);
        const name = input.trim();
        const lines = fs.readFileSync("np.txt", "utf8").split("\n").filter(Boolean);
        stopRequested = false;

        if (rkbInterval) clearInterval(rkbInterval);
        let index = 0;

        rkbInterval = setInterval(() => {
          if (index >= lines.length || stopRequested) {
            clearInterval(rkbInterval);
            rkbInterval = null;
            return;
          }
          api.sendMessage(`${name} ${lines[index]}`, threadID);
          index++;
        }, 60000);

        api.sendMessage(`sex hogya bche ğŸ¤£rkb ${name}`, threadID);
      }

      else if (cmd === "/stop") {
        stopRequested = true;
        if (rkbInterval) {
          clearInterval(rkbInterval);
          rkbInterval = null;
          api.sendMessage("chud gaye bcheğŸ¤£", threadID);
        } else {
          api.sendMessage("konsa gaLi du sale koğŸ¤£ rkb tha", threadID);
        }
      }

      else if (cmd === "/photo") {
        api.sendMessage("ğŸ“¸ Send a photo or video within 1 minute...", threadID);

        const handleMedia = async (mediaEvent) => {
          if (
            mediaEvent.type === "message" &&
            mediaEvent.threadID === threadID &&
            mediaEvent.attachments &&
            mediaEvent.attachments.length > 0
          ) {
            lastMedia = {
              attachments: mediaEvent.attachments,
              threadID: mediaEvent.threadID
            };

            api.sendMessage("âœ… Photo/video received. Will resend every 30 seconds.", threadID);

            if (mediaLoopInterval) clearInterval(mediaLoopInterval);
            mediaLoopInterval = setInterval(() => {
              if (lastMedia) {
                api.sendMessage({ attachment: lastMedia.attachments }, lastMedia.threadID);
              }
            }, 30000);

            api.removeListener("message", handleMedia);
          }
        };

        api.on("message", handleMedia);
      }

      else if (cmd === "/stopphoto") {
        if (mediaLoopInterval) {
          clearInterval(mediaLoopInterval);
          mediaLoopInterval = null;
          lastMedia = null;
          api.sendMessage("chud gaye sb.", threadID);
        } else {
          api.sendMessage("ğŸ¤£ro sale chnar", threadID);
        }
      }

      else if (cmd === "/forward") {
        try {
          const info = await api.getThreadInfo(threadID);
          const members = info.participantIDs;

          const msgInfo = event.messageReply;
          if (!msgInfo) return api.sendMessage("âŒ Kisi message ko reply karo bhai", threadID);

          for (const uid of members) {
            if (uid !== api.getCurrentUserID()) {
              try {
                await api.sendMessage({
                  body: msgInfo.body || "",
                  attachment: msgInfo.attachments || []
                }, uid);
              } catch (e) {
                console.log(`âš ï¸ Can't send to ${uid}:`, e.message);
              }
              await new Promise(res => setTimeout(res, 2000));
            }
          }

          api.sendMessage("ğŸ“¨ Forwarding complete.", threadID);
        } catch (e) {
          console.error("âŒ Error in /forward:", e.message);
          api.sendMessage("âŒ Error bhai, check logs", threadID);
        }
      }

      else if (cmd === "/target") {
        if (!args[1]) return api.sendMessage("ğŸ‘¤ UID de jisko target krna h", threadID);
        targetUID = args[1];
        api.sendMessage(`ye chudega bhen ka Lowda ${targetUID}`, threadID);
      }

      else if (cmd === "/cleartarget") {
        targetUID = null;
        api.sendMessage("ro kr kLp gya bkLğŸ¤£", threadID);
      }

      else if (cmd === "/help") {
        const helpText = `
ğŸ“Œ Available Commands:
/allname <name> â€“ Change all nicknames
/groupname <name> â€“ Change group name
/lockgroupname <name> â€“ Lock group name
/unlockgroupname â€“ Unlock group name
/uid â€“ Show group ID
/exit â€“ group se Left Le Luga
/rkb <name> â€“ HETTER NAME DAL
/stop â€“ Stop RKB command
/photo â€“ Send photo/video after this; it will repeat every 30s
/stopphoto â€“ Stop repeating photo/video
/forward â€“ Reply kisi message pe kro, sabko forward ho jaega
/target <uid> â€“ Kisi UID ko target kr, msg pe random gali dega
/cleartarget â€“ Target hata dega
/sticker<seconds> â€“ Sticker.txt se sticker spam (e.g., /sticker20)
/stopsticker â€“ Stop sticker loop
/help â€“ Show this help messageğŸ™‚ğŸ˜`;
        api.sendMessage(helpText.trim(), threadID);
      }

      else if (cmd.startsWith("/sticker")) {
        if (!fs.existsSync("Sticker.txt")) return api.sendMessage("âŒ Sticker.txt not found", threadID);

        const delay = parseInt(cmd.replace("/sticker", ""));
        if (isNaN(delay) || delay < 5) return api.sendMessage("ğŸ• Bhai sahi time de (min 5 seconds)", threadID);

        const stickerIDs = fs.readFileSync("Sticker.txt", "utf8").split("\n").map(x => x.trim()).filter(Boolean);
        if (!stickerIDs.length) return api.sendMessage("âš ï¸ Sticker.txt khali hai bhai", threadID);

        if (stickerInterval) clearInterval(stickerInterval);
        let i = 0;
        stickerLoopActive = true;

        api.sendMessage(`ğŸ“¦ Sticker bhejna start: har ${delay} sec`, threadID);

        stickerInterval = setInterval(() => {
          if (!stickerLoopActive || i >= stickerIDs.length) {
            clearInterval(stickerInterval);
            stickerInterval = null;
            stickerLoopActive = false;
            return;
          }

          api.sendMessage({ sticker: stickerIDs[i] }, threadID);
          i++;
        }, delay * 1000);
      }

      else if (cmd === "/stopsticker") {
        if (stickerInterval) {
          clearInterval(stickerInterval);
          stickerInterval = null;
          stickerLoopActive = false;
          api.sendMessage("ğŸ›‘ Sticker bhejna band", threadID);
        } else {
          api.sendMessage("ğŸ˜’ Bhai kuch bhej bhi rha tha kya?", threadID);
        }
      }

    } catch (e) {
      console.error("âš ï¸ Error in message handler:", e.message);
    }
  });
});
